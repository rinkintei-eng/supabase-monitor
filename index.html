<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DB Health Monitor</title>
    
    <!-- 1. ËºâÂÖ• Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ËºâÂÖ• React Âíå ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. ËºâÂÖ• Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. ËºâÂÖ• LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #e2e8f0;
            -webkit-tap-highlight-color: transparent;
        }
        /* Custom Scrollbar hide */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        /* Circular Progress Animation */
        .circle-progress {
            transition: stroke-dashoffset 1s ease-in-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==========================================
        // ‚öôÔ∏è Ë®≠ÂÆöÂçÄÂüü
        // ==========================================
        const CONFIG = {
            webhookUrl: "https://ez2.zeabur.app/webhook/monitor-db",
            apiKey: "yHEgVMncPY1p5oVLkJPfXQEPFPB3tQcAEKJcAMnFjv6sMTVtRPiEQzfkiU2uFimJRNsDaL3jEDxqnA3bMAszv9KqM0ns0cUJpLq0",
            liffId: "2008745394-ITY0EyKY"
        };
        
        const DEBUG_NO_LIFF = false; 

        // ==========================================
        // üîπ Icons Components
        // ==========================================
        const IconBase = ({ size = 24, className = "", children }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Database = (props) => <IconBase {...props}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></IconBase>;
        const ShieldCheck = (props) => <IconBase {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>;
        const User = (props) => <IconBase {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const Briefcase = (props) => <IconBase {...props}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconBase>;
        const WifiOff = (props) => <IconBase {...props}><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></IconBase>;

        // ==========================================
        // üîπ ÂúìÁí∞ÈÄ≤Â∫¶Ê¢ùÂÖÉ‰ª∂
        // ==========================================
        const CircularProgress = ({ percentage, colorClass }) => {
            const size = 140; // Á®çÂæÆÁ∏ÆÂ∞è‰ª•ÈÅ©ÊáâÈõôÂç°Áâá
            const stroke = 12; 
            const center = size / 2;
            const radius = (size - stroke) / 2;
            const circumference = radius * 2 * Math.PI;
            const strokeDashoffset = circumference - (percentage / 100) * circumference;

            return (
                <div className="relative flex items-center justify-center" style={{ width: size, height: size }}>
                    <svg 
                        width={size} 
                        height={size} 
                        viewBox={`0 0 ${size} ${size}`} 
                        className="rotate-[-90deg] block"
                    >
                        <circle
                            stroke="#e2e8f0"
                            strokeWidth={stroke}
                            fill="transparent"
                            r={radius}
                            cx={center}
                            cy={center}
                        />
                        <circle
                            className={`circle-progress ${colorClass}`}
                            stroke="currentColor"
                            strokeWidth={stroke}
                            strokeDasharray={circumference + ' ' + circumference}
                            style={{ strokeDashoffset }}
                            strokeLinecap="round"
                            fill="transparent"
                            r={radius}
                            cx={center}
                            cy={center}
                        />
                    </svg>
                    
                    <div className="absolute inset-0 flex flex-col items-center justify-center">
                        <span className={`text-3xl font-bold tabular-nums tracking-tight ${colorClass}`}>
                            {isNaN(percentage) ? '--' : percentage}%
                        </span>
                    </div>
                </div>
            );
        };

        // ==========================================
        // üîπ ÂñÆ‰∏ÄÁí∞Â¢ÉÂç°ÁâáÂÖÉ‰ª∂
        // ==========================================
        const EnvCard = ({ title, icon: Icon, data, formatBytes }) => {
            const getStatusColor = (pct, status) => {
                if (status === 'error') return { text: 'text-slate-400', bg: 'bg-slate-400', title: 'ÈÄ£Á∑öÂ§±Êïó', icon: WifiOff };
                if (pct >= 90) return { text: 'text-red-500', bg: 'bg-red-500', title: 'Âç±Èö™', icon: AlertTriangle };
                if (pct >= 80) return { text: 'text-yellow-500', bg: 'bg-yellow-500', title: 'Ë≠¶Âëä', icon: AlertTriangle };
                return { text: 'text-emerald-500', bg: 'bg-emerald-500', title: 'ÂÅ•Â∫∑', icon: ShieldCheck };
            };

            const colorInfo = getStatusColor(data.percentage, data.status);

            return (
                <div className="bg-white rounded-3xl p-5 shadow-sm border border-slate-200 relative overflow-hidden">
                    {data.percentage >= 90 && (
                        <div className="absolute inset-0 bg-red-500/5 animate-pulse pointer-events-none"></div>
                    )}
                    
                    {/* Âç°ÁâáÊ®ôÈ°å */}
                    <div className="flex justify-between items-center mb-4 border-b border-slate-50 pb-3">
                        <div className="flex items-center gap-2">
                            <div className="p-2 bg-slate-100 rounded-lg text-slate-600">
                                <Icon size={18} />
                            </div>
                            <span className="font-bold text-slate-700">{title}</span>
                        </div>
                        <div className={`flex items-center gap-1 text-xs font-bold px-2 py-1 rounded-full bg-opacity-10 ${colorInfo.text.replace('text-', 'bg-')}`}>
                            <colorInfo.icon size={12} />
                            <span>{colorInfo.title}</span>
                        </div>
                    </div>

                    {/* ÂÖßÂÆπÂçÄÂ°äÔºöÂ∑¶ÂúñÂè≥Êñá */}
                    <div className="flex items-center gap-4">
                        <CircularProgress percentage={data.percentage} colorClass={colorInfo.text} />
                        
                        <div className="flex-1 space-y-3">
                            <div>
                                <p className="text-[10px] text-slate-400 font-bold uppercase mb-0.5">Â∑≤‰ΩøÁî®</p>
                                <p className="text-base font-black text-slate-700">{formatBytes(data.used_bytes)}</p>
                            </div>
                            <div>
                                <p className="text-[10px] text-slate-400 font-bold uppercase mb-0.5">Á∏ΩÂÆπÈáè</p>
                                <p className="text-base font-black text-slate-700">{formatBytes(data.limit_bytes)}</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // üîπ ‰∏ªÁ®ãÂºè
        // ==========================================
        const App = () => {
            const [loading, setLoading] = useState(false);
            const [lastUpdate, setLastUpdate] = useState(new Date());
            
            const [liffState, setLiffState] = useState({ 
                init: false, 
                profile: null, 
                error: null 
            });

            // Ë≥áÊñôÁãÄÊÖãÔºöÊîπÁÇ∫ÂåÖÂê´ÂÖ©ÂÄãÁí∞Â¢É
            const [allData, setAllData] = useState({
                prod: { used_bytes: 0, limit_bytes: 524288000, percentage: 0, status: 'loading' },
                dev: { used_bytes: 0, limit_bytes: 524288000, percentage: 0, status: 'loading' }
            });

            // 1. ÂàùÂßãÂåñ LIFF
            useEffect(() => {
                const initLiff = async () => {
                    try {
                        if (DEBUG_NO_LIFF) {
                            setLiffState({ 
                                init: true, 
                                profile: { userId: 'DEBUG_USER_ID', displayName: 'Debug User' }, 
                                error: null 
                            });
                            return;
                        }
                        await liff.init({ liffId: CONFIG.liffId });
                        if (!liff.isLoggedIn()) {
                            liff.login();
                            return;
                        }
                        const profile = await liff.getProfile();
                        setLiffState({ init: true, profile, error: null });
                    } catch (err) {
                        console.error('LIFF Error:', err);
                        setLiffState({ init: true, profile: null, error: err.message });
                    }
                };
                initLiff();
            }, []);

            // 2. LIFF ÂàùÂßãÂåñÂæåÊäìË≥áÊñô
            useEffect(() => {
                if (liffState.init) {
                    fetchData();
                }
            }, [liffState.init]);

            const fetchData = async () => {
                setLoading(true);

                try {
                    const payload = { 
                        env: 'all', 
                        userId: liffState.profile?.userId || 'unknown'
                    };

                    const res = await fetch(CONFIG.webhookUrl, { 
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-App-only-OPEN': CONFIG.apiKey
                        },
                        body: JSON.stringify(payload) 
                    }); 
                    
                    if (!res.ok) throw new Error(`API Error: ${res.status}`);
                    
                    const json = await res.json();
                    
                    // üî• Êõ¥Êñ∞ÂæåÁöÑÊé•Êî∂ÈÇèËºØÔºöËôïÁêÜÈô£ÂàóÊ†ºÂºè [Ê≠£Âºè, ÂÄã‰∫∫]
                    if (Array.isArray(json) && json.length >= 2) {
                        setAllData({
                            prod: json[0], // Á¨¨‰∏ÄÁ≠Ü
                            dev: json[1]   // Á¨¨‰∫åÁ≠Ü
                        });
                    } else if (Array.isArray(json) && json.length === 1) {
                        // Èò≤ÂëÜÔºöËã•Âè™Êúâ‰∏ÄÁ≠ÜÔºåÂÑ™ÂÖàÁµ¶ Prod
                        setAllData(prev => ({ ...prev, prod: json[0] }));
                    } else if (json.prod || json.dev) {
                        // ‰øùÁïôÂ∞çËàäÊ†ºÂºèÁâ©‰ª∂ÁöÑÁõ∏ÂÆπÊÄß
                        setAllData(prev => ({
                            prod: json.prod || prev.prod,
                            dev: json.dev || prev.dev
                        }));
                    } else {
                        console.warn("Êú™Áü•ÁöÑË≥áÊñôÊ†ºÂºè:", json);
                    }

                    setLastUpdate(new Date());

                } catch (err) {
                    console.error("Fetch Error:", err);
                    setAllData(prev => ({
                        prod: { ...prev.prod, status: 'error' },
                        dev: { ...prev.dev, status: 'error' }
                    }));
                } finally {
                    setLoading(false);
                }
            };

            const formatBytes = (bytes) => {
                if (!bytes || bytes === 0) return '0 MB';
                const mb = bytes / (1024 * 1024);
                return mb.toFixed(2) + ' MB';
            };

            if (!liffState.init) {
                return (
                    <div className="min-h-screen bg-slate-200 flex items-center justify-center">
                        <div className="flex flex-col items-center animate-pulse">
                            <div className="w-12 h-12 bg-emerald-400 rounded-full mb-4"></div>
                            <p className="text-slate-500 font-bold">LINE Login...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen w-full flex justify-center items-start sm:py-10">
                    <div className="w-full max-w-md bg-slate-100 min-h-screen sm:min-h-[800px] sm:h-auto sm:rounded-[2.5rem] shadow-2xl relative overflow-hidden ring-8 ring-slate-900/5 font-sans text-slate-800 flex flex-col">
                        
                        {/* Header */}
                        <div className="bg-slate-900 text-white p-6 pb-6 rounded-b-[2.5rem] shadow-lg z-10 sticky top-0">
                            <div className="flex justify-between items-center">
                                <div>
                                    <span className="text-slate-400 text-xs font-bold tracking-widest uppercase flex items-center gap-1">
                                        <div className={`w-2 h-2 rounded-full ${loading ? 'bg-yellow-400 animate-pulse' : 'bg-emerald-400'}`}></div>
                                        System Monitor
                                    </span>
                                    <h1 className="text-xl font-bold mt-1">Ë≥áÊñôÂ∫´Áõ£Êéß‰∏≠ÂøÉ</h1>
                                </div>
                                
                                <div className="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center border border-slate-700 overflow-hidden">
                                    {liffState.profile?.pictureUrl ? (
                                        <img src={liffState.profile.pictureUrl} alt="user" className="w-full h-full object-cover" />
                                    ) : (
                                        <User size={20} className="text-slate-300"/>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Main Content */}
                        <div className="flex-1 px-5 pt-6 pb-20 -mt-2 z-0 overflow-y-auto hide-scrollbar space-y-4">
                            
                            {/* 1. Ê≠£ÂºèÁí∞Â¢ÉÂç°Áâá */}
                            <EnvCard 
                                title="Ê≠£ÂºèÁí∞Â¢É (Prod)" 
                                icon={Briefcase} 
                                data={allData.prod} 
                                formatBytes={formatBytes} 
                            />

                            {/* 2. ÂÄã‰∫∫Áî®Áí∞Â¢ÉÂç°Áâá */}
                            <EnvCard 
                                title="ÂÄã‰∫∫Áî®ÈÄî (Dev)" 
                                icon={User} 
                                data={allData.dev} 
                                formatBytes={formatBytes} 
                            />

                        </div>

                        {/* Footer Action */}
                        <div className="absolute bottom-0 w-full p-6 bg-gradient-to-t from-slate-100 via-slate-100 to-transparent">
                            <button 
                                onClick={fetchData} 
                                disabled={loading}
                                className="w-full py-4 rounded-2xl bg-slate-900 text-white font-bold text-lg shadow-xl shadow-slate-300 flex items-center justify-center gap-2 active:scale-95 transition-transform disabled:opacity-70"
                            >
                                <RefreshCw size={20} className={loading ? "animate-spin" : ""} />
                                {loading ? "Êõ¥Êñ∞Êï∏Êìö‰∏≠..." : "ÈáçÊñ∞Êï¥ÁêÜ"}
                            </button>
                            <p className="text-center text-[10px] text-slate-400 mt-3 font-mono">
                                Last Updated: {lastUpdate.toLocaleTimeString()}
                            </p>
                        </div>

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
